// ============================================================================
// INTEGRATION TEST - END-TO-END TEST
// ============================================================================
// هذا الملف يختبر التطبيق بالكامل من البداية للنهاية
// Integration Test: اختبار التكامل - يختبر جميع الطبقات معاً
// End-to-End: من البداية للنهاية - سيناريو كامل للمستخدم
// ============================================================================

// استيراد Flutter Material widgets
import 'package:flutter/material.dart';

// استيراد مكتبة الاختبار الأساسية
import 'package:flutter_test/flutter_test.dart';

// استيراد main.dart كـ app لتجنب تعارض الأسماء
// main.dart: نقطة البداية للتطبيق
// as app: استيراد باسم app - يمكن استخدام app.main()
// الهدف: تجنب تعارض الأسماء مع main() في الاختبار
import 'package:food_delivery/main.dart' as app;

// استيراد integration_test - مكتبة اختبار التكامل
// integration_test: مكتبة لاختبار التطبيق بالكامل
// IntegrationTestWidgetsFlutterBinding: binding للـ Integration Test
import 'package:integration_test/integration_test.dart';

// ============================================================================
// تعليق يوضح نوع الاختبار
// Integration Test: اختبار التكامل - التطبيق بالكامل
// App Test: اختبار التطبيق
// ============================================================================
/// Integration Test: App Test

// main(): نقطة البداية
void main() {
  // ==========================================================================
  // تهيئة Integration Test Binding
  // ==========================================================================
  // IntegrationTestWidgetsFlutterBinding: binding للـ Integration Test
  // ensureInitialized(): تهيئة Integration Test binding
  // ضروري: يجب استدعاؤه قبل أي اختبار Integration
  // الهدف: إعداد بيئة الاختبار للتطبيق الكامل
  IntegrationTestWidgetsFlutterBinding.ensureInitialized();

  // ==========================================================================
  // GROUP: تجميع الاختبارات
  // ==========================================================================
  // group(): تجميع الاختبارات المتعلقة
  // 'end-to-end test': اسم المجموعة - اختبار من البداية للنهاية
  // End-to-End: سيناريو كامل من البداية للنهاية
  group('end-to-end test', () {
    // ========================================================================
    // TEST: سيناريو كامل للمستخدم
    // ========================================================================
    // testWidgets(): اختبار Widget (لكن للتطبيق الكامل)
    // 'complete user flow: search and add to cart': اسم الاختبار
    // WidgetTester tester: أداة للتفاعل مع Widgets
    // async: الاختبار غير متزامن
    testWidgets('complete user flow: search and add to cart', (
      WidgetTester tester,
    ) async {
      // ======================================================================
      // STEP 1: بدء التطبيق
      // ======================================================================
      // Start the app

      // app.main(): بدء التطبيق بالكامل
      // app: الاسم الذي استوردنا به main.dart
      // main(): نقطة البداية للتطبيق
      // الهدف: بدء التطبيق كما يبدأه المستخدم الحقيقي
      app.main();

      // await: انتظار اكتمال بدء التطبيق
      // pumpAndSettle(): انتظار اكتمال جميع الـ frames والرسوم المتحركة
      // الهدف: التأكد من تحميل جميع الشاشات والبيانات
      await tester.pumpAndSettle();

      // ======================================================================
      // STEP 2: البحث عن شريط البحث والنقر عليه
      // ======================================================================
      // Find and tap the search bar

      // final: متغير ثابت
      // searchBar: متغير يحتوي على نتيجة البحث
      // find.byType(TextField): البحث عن widget حسب النوع
      // TextField: نوع الـ widget - حقل إدخال النص
      // الهدف: العثور على شريط البحث في الواجهة
      final searchBar = find.byType(TextField);

      // expect(): التحقق من وجود شريط بحث واحد فقط
      // searchBar: نتيجة البحث
      // findsOneWidget: matcher يتحقق من وجود widget واحد فقط
      // الهدف: التأكد من أن التطبيق تم تحميله بشكل صحيح
      expect(searchBar, findsOneWidget);

      // await: انتظار اكتمال العملية
      // tap(): محاكاة النقر على widget
      // searchBar: الـ widget الذي نريد النقر عليه
      // الهدف: تفعيل شريط البحث (focus)
      await tester.tap(searchBar);

      // await: انتظار اكتمال التفاعل
      // pumpAndSettle(): انتظار اكتمال جميع العمليات
      // الهدف: التأكد من تفعيل شريط البحث
      await tester.pumpAndSettle();

      // ======================================================================
      // STEP 3: إدخال نص في شريط البحث
      // ======================================================================
      // Enter search query

      // await: انتظار اكتمال العملية
      // enterText(): إدخال نص في TextField
      // searchBar: الـ TextField الذي نريد إدخال النص فيه
      // 'fruit': النص المدخل - كلمة البحث
      // الهدف: محاكاة كتابة المستخدم في شريط البحث
      await tester.enterText(searchBar, 'fruit');

      // await: انتظار اكتمال البحث
      // pumpAndSettle(): انتظار اكتمال عملية البحث
      // الهدف: التأكد من اكتمال البحث وعرض النتائج
      await tester.pumpAndSettle();

      // ======================================================================
      // STEP 4: التحقق من عرض نتائج البحث
      // ======================================================================
      // Verify search results are displayed

      // expect(): التحقق من عرض نتائج البحث
      // find.text('نتائج البحث'): البحث عن النص العربي "نتائج البحث"
      // findsOneWidget: يجب أن يكون widget واحد فقط
      // الهدف: التأكد من عرض عنوان نتائج البحث
      expect(find.text('نتائج البحث'), findsOneWidget);

      // ======================================================================
      // STEP 5: النقر على زر إضافة للسلة
      // ======================================================================
      // Tap on a product to add to cart

      // final: متغير ثابت
      // addToCartButton: متغير يحتوي على نتيجة البحث
      // find.byIcon(): البحث عن widget حسب الأيقونة
      // Icons.add_shopping_cart: أيقونة إضافة للسلة
      // الهدف: العثور على زر إضافة المنتج للسلة
      final addToCartButton = find.byIcon(Icons.add_shopping_cart);

      // if: شرط - التحقق من وجود نتائج
      // addToCartButton.evaluate(): تقييم البحث - الحصول على النتائج
      // isNotEmpty: التحقق من أن النتائج ليست فارغة
      // الهدف: التأكد من وجود منتجات قبل محاولة النقر
      // ملاحظة: قد لا يكون هناك منتجات في بعض الحالات (API فاشل، Local فارغ)
      if (addToCartButton.evaluate().isNotEmpty) {
        // await: انتظار اكتمال العملية
        // tap(): محاكاة النقر على widget
        // addToCartButton.first: أول نتيجة من البحث
        // first: أول عنصر في القائمة
        // الهدف: النقر على زر إضافة أول منتج للسلة
        await tester.tap(addToCartButton.first);

        // await: انتظار اكتمال العملية
        // pumpAndSettle(): انتظار اكتمال إضافة المنتج للسلة
        // الهدف: التأكد من اكتمال العملية
        await tester.pumpAndSettle();

        // ====================================================================
        // STEP 6: التحقق من ظهور رسالة النجاح
        // ====================================================================
        // Verify snackbar appears

        // expect(): التحقق من ظهور رسالة النجاح
        // find.text('added to cart'): البحث عن نص "added to cart"
        // findsOneWidget: يجب أن يكون widget واحد فقط
        // الهدف: التأكد من ظهور Snackbar يخبر المستخدم أن المنتج تم إضافته
        // Snackbar: رسالة مؤقتة تظهر في أسفل الشاشة
        expect(find.text('added to cart'), findsOneWidget);
      }
      // إذا لم يكن هناك منتجات، يتم تخطي هذا الجزء
      // هذا طبيعي في بعض الحالات (API فاشل، Local فارغ)
    });
  });
}

// ============================================================================
// ملاحظات مهمة:
// ============================================================================
// 1. Integration Test يختبر التطبيق بالكامل - جميع الطبقات معاً
// 2. ensureInitialized(): ضروري قبل أي Integration Test
// 3. app.main(): بدء التطبيق كما يبدأه المستخدم الحقيقي
// 4. pumpAndSettle(): انتظار اكتمال جميع العمليات
// 5. find.byType(): البحث حسب النوع
// 6. find.byIcon(): البحث حسب الأيقونة
// 7. find.text(): البحث حسب النص
// 8. tap(): محاكاة النقر
// 9. enterText(): إدخال نص
// 10. Integration Tests بطيئة نسبياً - تستغرق وقتاً أطول من Unit/Widget Tests
// ============================================================================
